<!DOCTYPE html>
<html dir="ltr" lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0" />

    <title>2022 DC ANC Elections | GGWash</title>

    <script type="module" src="./../build/dc-election.esm.js"></script>
    <script nomodule src="./../build/dc-election.js"></script>

<!-- <script src="https://js.arcgis.com/4.24/" data-esri-loader="loaded"></script>
  <link rel="stylesheet" href="https://js.arcgis.com/4.21/esri/themes/light/main.css"> -->
<link rel='stylesheet' type='text/css' href='https://unpkg.com/@esri/calcite-components@1.0.0-next.292/dist/calcite/calcite.css' />
<script type='module' src='https://unpkg.com/@esri/hub-components@4.0.0-beta.341/dist/hub-components/hub-components.esm.js'></script>
  </head>
  <body>
  
  <div class="navbar">
  </div>  
  <div class="main">
    <dc-election-survey 
        id="anc" 
        filename="./../assets/2022_anc.csv" 
        format="surveymonkey"
        show-filter=true
        filter=""
      >
      <h2 slot="title">DC ANC</h2>
      <div slot="filter">
        <arcgis-hub-map
            style='height: 400px;'
            zoom="10"
            center="-77.05,38.9"
            basemap="gray-vector"
        ></arcgis-hub-map>
      </div>
    </dc-election-survey>
  </div>
  <style>
    body {
      font-family: sans-serif;
      margin: 0;
      padding: 0;
      overflow-x: hidden;
    }

    .navbar, .main {
      padding: 0 8px;
    }
    /* The navigation bar */
    .navbar {
      overflow: hidden;
      background-color: white;
      position: fixed; /* Set the navbar to fixed position */
      top: 0; /* Position the navbar at the top of the page */
      width: 100%; /* Full width */
      box-shadow: 0 3px 5px rgba(57, 63, 72, 0.3);      
    }

    .navbar h1 {
      font-size: 2rem;
      margin-bottom: 0.5rem;
    }
    /* Links inside the navbar */
    .navbar a {
      float: left;
      display: block;
      text-align: center;
      padding: 14px 16px;
      text-decoration: none;
    }

    /* Change background on mouse-over */
    .navbar a:hover {
      background: #ddd;
      color: black;
    }

    /* show horizontal scope */
    #parking {
      min-width: 1300px;
      overflow: scroll;
    }

    /* Main content */
    .main {
      margin-top: 0; /* Add a top margin to avoid content overlay */
    }
    dc-election-survey {
      scroll-margin-top: 60px;
    }    

  </style>

  <script>
    
    const $surveyEl = document.querySelector('dc-election-survey');
    function changeFilter( filter ) {
      $surveyEl.filter = filter;
    }

    const $mapEl = document.querySelector('arcgis-hub-map');
    $mapEl.addEventListener('arcgisHubMapViewReady', function (event) {
        const { detail: { view, loadModules } } = event;
        loadModules([
            'esri/geometry/Extent',
            'esri/layers/FeatureLayer',
            "esri/layers/support/LabelClass",
            'esri/widgets/Search'
        ])
            .then( ([Extent, FeatureLayer, LabelClass, Search]) => {
                // Add ANC Boundaries
                const ancStyle = {
                  type: "simple",
                  symbol: { type: "simple-fill" }
                }
                const ancLabels = new LabelClass({
                  labelExpressionInfo: { expression: "$feature.NAME" },
                  symbol: {
                    type: "text",  // autocasts as new TextSymbol()
                    color: "#0f9535",
                    haloSize: 0.5,
                    haloColor: "black",
                    font: {size: 12},
                    weight: "bold"
                  }
                });

                const ancLayer = new FeatureLayer({
                    url: "https://maps2.dcgis.dc.gov/dcgis/rest/services/DCGIS_DATA/Administrative_Other_Boundaries_WebMercator/MapServer/54",
                    renderer: ancStyle,
                    labelingInfo: [ ancLabels ]
                });

                const smdStyle = {
                  type: "simple",
                  symbol: { 
                    type: "simple-fill",
                    opacity: 0,
                    outline: {  // autocasts as new SimpleLineSymbol()
                      width: 1,
                      color: "white"
                    }
                  }
                }
                const smdLabels = new LabelClass({
                  labelExpressionInfo: { expression: "$feature.SMD_ID" },
                  symbol: {
                    type: "text",  // autocasts as new TextSymbol()
                    color: "white",
                    haloSize: 0.5,
                    haloColor: "black",
                    font: {size: 8},
                    maxScale: 0,
                    minScale: 1000000,
                  }
                });
                const smdLayer = new FeatureLayer({
                  url: "https://maps2.dcgis.dc.gov/dcgis/rest/services/DCGIS_DATA/Administrative_Other_Boundaries_WebMercator/MapServer/55",
                  renderer: smdStyle,
                  labelingInfo: [ smdLabels ]
                })

                view.map.add(smdLayer);
                view.map.add(ancLayer);

                view.highlightOptions = {
                  color: "#0f9535"
                }

                const theExtent = new Extent({
                  xmin:-8584947.85844689,
                  ymin:4691862.387048862,
                  xmax:-8561472.787091771,
                  ymax:4721095.072076196,
                  spatialReference: {
                    wkid: 3857
                  }
                });

                const searchExtent = {
                  geometry: theExtent
                };
                const sources = [{
                    url: "https://geocode.arcgis.com/arcgis/rest/services/World/GeocodeServer",
                    name: "DC Address Search",
                    zoomScale: 50000,
                    filter: searchExtent
                  },{
                    layer: ancLayer,
                    placeholder: "Search ANC",
                    maxResults: 5,
                    searchFields: ["NAME"],
                    displayField: "NAME",
                    name: "DC ANC"
                  }];
                const searchWidget = new Search({
                  view: view,
                  includeDefaultSources: false,
                  sources: sources
                });

                // Adds the search widget below other elements in
                // the top left corner of the view
                view.ui.add(searchWidget, {
                  position: "top-right",
                  index: 2
                });
                searchWidget.on("search-complete", function(event){
                  // The results are stored in the event Object[]
                  console.log("Results of the search: ", event);
                });

              view
                  .when()
                  .then(() => {
                    return ancLayer.when();
                  })
                  .then((layer) => {
                    // const renderer = layer.renderer.clone();
                    // renderer.symbol.width = 4;
                    // renderer.symbol.color = [128, 128, 128, 0.8];
                    // layer.renderer = renderer;

                    // Set up an event handler for pointer-down (mobile)
                    // and pointer-move events (mouse)
                    // and retrieve the screen x, y coordinates

                    return view.whenLayerView(layer);
                  })
                  .then((layerView) => {
                    view.on("pointer-move",mapHoverHandler);
                    view.on("pointer-down",mapClickHandler);
                    function mapHoverHandler(event) {
                      // only include graphics from hurricanesLayer in the hitTest
                      const opts = {
                        include: ancLayer
                      }
                      view.hitTest(event, opts).then(highlightFeature);                      
                    }
                    function mapClickHandler(event) {
                      console.log("selected ANC", {currentANCName})
                      changeFilter(currentANCName);
                    }                    

                    // view.on("click", function(event){
                    //   // event is the event handle returned after the event fires.
                    //   console.log("Map Click", event.mapPoint);
                    // });
                    let highlight, currentANCName;
                    function highlightFeature(response) {
                        // check if a feature is returned from the hurricanesLayer
                        if (response.results.length) {
                          const graphic = response.results[0].graphic;
                          // do something with the graphic
                          const attributes = graphic.attributes;
                          const objectid = attributes.OBJECTID;
                          const name = attributes.NAME;
                          const query = layerView.createQuery();
                          query.where = "OBJECTID = " + objectid;
                          layerView.queryObjectIds(query).then((ids) => {
                            if (highlight) {
                              highlight.remove();
                            }
                            highlight = layerView.highlight(ids);
                            currentANCName = name;
                          }); 
                        }
                    }
                  })

        });
    });  
  </script>
  </body>
</html>
