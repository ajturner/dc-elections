{"version":3,"sources":["src/components/dc-election-survey/dc-election-survey.css?tag=dc-election-survey","src/components/dc-election-survey/dc-election-survey.tsx"],"names":["dcElectionSurveyCss","DcElectionSurvey","[object Object]","hostRef","this","filename","format","candidatesFiles","filter","showFilter","candidates","questions","loading","stopFilterPropagation","Response.fetchResponses","Response.fetchCandidates","getFilterBookmark","state","event","detail","feature","undefined","console","debug","attributes","featureSummaryEl","race","SMD_ID","website","WEB_URL","ANC_ID","value","newValue","filterDropdownEl","setFilterBookmark","slice","length","mapEl","selectFeature","filterInput","h","class","name","ref","el","question","responses","type","Type","renderSummary","map","renderQuestion","renderFilter","renderHelp","Host","renderLoader","renderBody"],"mappings":"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","sourcesContent":[":host {\n  display: block;\n  font-family: sans-serif;\n}\n.filter {\n  max-width: 800px;\n}\n.help {\n  margin: 1em 0;\n  padding: 1em 0 1em 1em;\n  border: thin solid #0f9535;\n  max-width: 780px;\n}\n/* contains card within filter */\n.filter {\n  position: relative;\n}\ndc-map {\n  height: 400px;\n  width: 400px;\n}\ndc-feature-summary {\n  position: absolute;\n  top: 250px;\n  background-color: rgba(255,255,255, 0.8);\n  width: 300px;\n}\ndc-filter {\n  margin-top: 0.5em;\n}\nol {\n  /* margin: 0 0 0 1em; */\n  padding: 0;\n  font: italic 2em Georgia;\n  color: #666;\n  list-style-position: outside;\n  padding-left: 1.5em;\n}\nol dc-election-question {\n  font: normal 16px Helvetica, Arial, Sans-Serif;\n  color: #000;  \n}\nol li {\n  border-top: thin solid #444;\n  margin-top: 1em;\n}\n\ninput {\n  font-size: 1.2em;\n  height: 2em;\n  width: 12em;\n  margin: 0 1em;\n}","import { Component, Event, EventEmitter, Host, h, Prop, State, Watch, Listen } from '@stencil/core';\nimport * as Response from '../../utils/response'\nimport state from '../../utils/store';\n// @ts-ignore\nimport HTMLCalciteComboboxElement from \"@esri/calcite-components/dist/components/calcite-combobox\";\n// @ts-ignore\nimport HTMLDcFilterElement from '../dc-filter';\nimport { getFilterBookmark, setFilterBookmark } from '../../utils/utils';\n\n@Component({\n  tag: 'dc-election-survey',\n  styleUrl: 'dc-election-survey.css',\n  shadow: false,\n})\nexport class DcElectionSurvey {\n  /**\n   * URL to Survey responses\n   */\n  @Prop() filename:string = null;\n\n  /**\n   * Format of the Survey: column | row | surveymonkey\n   */\n  @Prop() format:string = \"column\";\n  \n  /**\n  * Optional URL to CSV to candidates: Race,Name,Website\n  */\n  @Prop() candidatesFiles:string = null;\n\n  /** String to filter Race\n   */\n  @Prop({ mutable: true, reflect: true }) filter:string = null;\n\n  /**\n   * Option to show or hide the Map + dropdown\n   */\n  @Prop() showFilter:boolean = false;\n\n  // TODO: can this move to the state handler?\n  @Event({ cancelable: false })  filterChanged: EventEmitter<any>;\n\n  @State() candidates: Array<any> = [];\n  @State() questions: Array<any> = [];\n  @State() loading: boolean = true;\n\n  filterInput!: HTMLInputElement;\n  filterDropdownEl: HTMLDcFilterElement;\n  featureSummaryEl: HTMLDcFeatureSummaryElement;\n  mapEl: HTMLDcMapElement;\n\n  async componentDidLoad() {\n    this.questions = await Response.fetchResponses(this.filename, this.format);\n\n    // Optionally load a CSV of Candidates (Race,Name,Website)\n    if(!!this.candidatesFiles) {\n      this.candidates = await Response.fetchCandidates( this.candidatesFiles )\n    }\n\n    this.filter = getFilterBookmark();\n    if(!!this.filter) {\n      // set the filter state\n      state.filter = this.filter;\n    }\n    // console.debug(\"dc-election-survey\", {candidates: this.candidates, questions: this.questions})\n    this.loading = false;\n  }\n\n  // TODO: This is a hack to stop propagating events all around, stopping map zoom\n  @State() stopFilterPropagation: boolean = false;\n\n  @Listen(\"featureSelected\")\n  featureSelectedHandler(event) {\n    \n    this.stopFilterPropagation = true;\n    if(event.detail.feature !== undefined) {\n      console.debug(\"dc-election-survey: featureSelectedHandler\", event.detail.feature.attributes);\n      this.featureSummaryEl.race = event.detail.feature.attributes.SMD_ID;\n      this.featureSummaryEl.website = event.detail.feature.attributes.WEB_URL;\n      this.filter = event.detail.feature.attributes.ANC_ID;\n    } else {\n      this.filter = \"\";\n      this.featureSummaryEl.race = \"\";\n    }\n    state.filter = this.filter;\n    \n  }\n  @Listen(\"filterChanged\")\n  filterChangedHandler(event) {\n    // console.debug(\"dc-election-survey: filterChangedHandler\", event.detail.value)\n    this.filter = event.detail.value;\n\n    // Update summary if the filter is an SMD\n    if(!this.stopFilterPropagation) {\n      this.featureSummaryEl.race = event.detail.value;\n    }\n    this.stopFilterPropagation = false;\n  }\n\n  @Watch('filter')\n  filterPropChanged(newValue: string) {\n    // console.debug(\"dc-election-survey: filterPropChanged\", {newValue})\n    // TODO move these to reactive props on elements\n    if(!!this.filterDropdownEl) {\n      this.filterDropdownEl.value = newValue;\n    }\n\n    setFilterBookmark(newValue)\n    \n    const feature = { attributes: {\n      ANC_ID: newValue.slice(0,2)\n    }};\n    if(newValue.length === 4) {\n      feature.attributes['SMD_ID'] = newValue;\n    }\n    \n    if(!this.stopFilterPropagation && !!this.mapEl) {\n      // @ts-ignore for some reason doesn't detect that mathod has two parameters\n      this.mapEl.selectFeature( feature, false /* emitEvent */ );    \n      state.filter = newValue;\n    }\n  }\n  \n  clearFilters() {\n    this.filter = '';\n    state.filter = '';\n    if(this.filterInput) {\n      this.filterInput.value = '';\n    }\n    \n    return false; // prevent routing/actions\n  }\n\n  renderFilter(filter:string) {\n    console.debug(\"dc-election-survey: renderFilter\", {filter})\n    if(this.showFilter) {\n      return (\n        <div class=\"filter\">\n          <slot name=\"filter\"></slot>\n          <dc-map\n            ref={(el) => this.mapEl = el}\n          ></dc-map>\n          <dc-feature-summary\n            candidates={this.candidates}\n            ref={(el) => this.featureSummaryEl = el}\n          ></dc-feature-summary>\n          <dc-filter\n            ref={(el) => this.filterDropdownEl = el}\n            filter={filter}\n          >\n          \n          </dc-filter>\n\n          {/* <input onChange={this.filterHandler} \n                 ref={(el) => this.filterInput = el} \n                 value={filter} \n                 placeholder=\"Search by Ward or ANC\"\n            ></input>\n          <a href='#' onClick={this.clearFilters}>clear</a> */}\n        </div>\n      )\n    }\n    \n  }\n  \n  // Render differently depending on type\n  renderQuestion(question: Response.ISurveyResponse) {\n    return (\n      <dc-election-question \n        question={question.question}\n        responses={question.responses}\n        type={question.question.Type}\n      ></dc-election-question>\n    )\n  }\n  renderHelp() {\n    return (\n      <div>\n        <div class=\"help\">\n          Filter to local candidates by clicking on the map, search by address, or select ANC or SMD.\n        </div>\n        {this.renderSummary()}\n      </div>\n    )\n  }\n  renderSummary() {\n    return (\n      <dc-survey-summary\n        class=\"summary\"\n        questions={this.questions}\n      ></dc-survey-summary>      \n    )\n  }\n\n  // TODO: Simplify the filter logic\n  renderBody(filter:string) {\n    const questions = (\n      <ol>\n        {this.questions.map((question) => {\n          return (<li>{this.renderQuestion(question)}</li>);  \n        })}\n      </ol>)\n    return (\n      <div class=\"questions\">\n        {this.renderFilter(filter)}\n        {!this.showFilter || filter === null || (!!filter && filter.length !== 0) ? questions : this.renderHelp()}\n      </div>\n    )\n  }\n\n  renderLoader() {\n    return (<dc-loader>Loading survey responses...</dc-loader>);\n  }\n  render() {\n    return (\n      <Host>\n        <slot name=\"title\"></slot>\n        \n        {this.loading || this.questions.length === 0 ? this.renderLoader() : this.renderBody(this.filter) }\n        \n      </Host>\n    );\n  }\n\n}\n"]}